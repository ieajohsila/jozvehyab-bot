import nest_asyncio
nest_asyncio.apply()

import logging
import os
from sqlalchemy import create_engine # <-- Ú©ØªØ§Ø¨Ø®Ø§Ù†Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯
from telegram import Update
from telegram.ext import Application, CommandHandler, MessageHandler, filters, ContextTypes

# Ø®ÙˆØ§Ù†Ø¯Ù† Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ
TELEGRAM_BOT_TOKEN = os.environ.get("TELEGRAM_BOT_TOKEN")
DATABASE_URL = os.environ.get("DATABASE_URL") # <-- Ø¢Ø¯Ø±Ø³ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ Ø®ÙˆØ§Ù†Ø¯Ù‡ Ø´Ø¯

# ÙØ¹Ø§Ù„ Ú©Ø±Ø¯Ù† Ù„Ø§Ú¯â€ŒÚ¯ÛŒØ±ÛŒ
logging.basicConfig(
    format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO
)
logger = logging.getLogger(__name__)


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Ù¾Ø§Ø³Ø® Ø¨Ù‡ Ø¯Ø³ØªÙˆØ± /start"""
    user = update.effective_user
    await update.message.reply_html(
        f"Ø³Ù„Ø§Ù… {user.mention_html()}! ğŸ‘‹\n\n"
        f"Ø¨Ù‡ Ø±Ø¨Ø§Øª Â«Ø¬Ø²ÙˆÙ‡â€ŒÛŒØ§Ø¨Â» Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯.",
    )

async def echo(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """ØªÚ©Ø±Ø§Ø± Ù¾ÛŒØ§Ù… Ú©Ø§Ø±Ø¨Ø±"""
    await update.message.reply_text("Ø±Ø¨Ø§Øª Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ³Ø¹Ù‡ Ø§Ø³Øª...")


def main() -> None:
    """Ø§Ø¬Ø±Ø§ÛŒ Ø§ØµÙ„ÛŒ Ø±Ø¨Ø§Øª"""
    # --- Ø´Ø±ÙˆØ¹ Ø¨Ø®Ø´ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ---
    if not DATABASE_URL:
        print("âŒ Ø®Ø·Ø§: Ø¢Ø¯Ø±Ø³ Ø§ØªØµØ§Ù„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ (DATABASE_URL) ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        return

    try:
        engine = create_engine(DATABASE_URL)
        connection = engine.connect()
        print("âœ… Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø±Ù‚Ø±Ø§Ø± Ø´Ø¯.")
        connection.close()
    except Exception as e:
        print(f"âŒ Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ù¾Ø§ÛŒÚ¯Ø§Ù‡ Ø¯Ø§Ø¯Ù‡: {e}")
        return
    # --- Ù¾Ø§ÛŒØ§Ù† Ø¨Ø®Ø´ ØªØ³Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Ø¯ÛŒØªØ§Ø¨ÛŒØ³ ---

    if not TELEGRAM_BOT_TOKEN:
        print("âŒ Ø®Ø·Ø§: ØªÙˆÚ©Ù† ØªÙ„Ú¯Ø±Ø§Ù… ÛŒØ§ÙØª Ù†Ø´Ø¯.")
        return

    application = Application.builder().token(TELEGRAM_BOT_TOKEN).build()

    application.add_handler(CommandHandler("start", start))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, echo))

    print("Ø±Ø¨Ø§Øª Â«Ø¬Ø²ÙˆÙ‡â€ŒÛŒØ§Ø¨Â» Ø¢Ù…Ø§Ø¯Ù‡ Ø¨Ù‡ Ú©Ø§Ø± Ø§Ø³Øª...")
    application.run_polling()


if __name__ == "__main__":
    main()
